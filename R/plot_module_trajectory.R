#' PLot scaled changes in modules eigenvalue alongside inferred_psuedotime
#'
#' @param modules List object generated by `multiomics_modules()`
#' @param covariates covariates to add on plot
#' @param plot_modules Modules of interest for plot
#'
#' @return ggplot
#'
#' @family Multi-omic integration downstream analysis
#' @import ggplot2
#' @importFrom tidyr gather
#'
#' @export

plot_module_trajectory <- function(modules,
                                   covariates=c('amyloid','AT8','PHF1'),
                                   plot_modules=c("ME1","ME2","ME3","ME4")
                                   ){

  metadata <- modules$metadata_modules

  for (i in colnames(modules$modules_eigen_value)) {
    metadata[, i] <- .range01(metadata[, i])
  }

  for (i in covariates) {
    metadata[, i] <- .range01(metadata[, i])
  }


  df <- tidyr::gather(metadata[, c(covariates, "inferred_pseudotime")], covariates, scaled_change, 1:length(covariates))
  df2 <- tidyr::gather(metadata[, c(plot_modules, "inferred_pseudotime")], modules, scaled_change, 1:length(plot_modules))


  plot= ggplot2::ggplot(df2, ggplot2::aes_string("inferred_pseudotime", "scaled_change")) +
    ggplot2::geom_point() +
    ggplot2::geom_smooth(data = df, se = F, method = "lm", linetype = "dashed", size = 0.5,aes(colour=covariates)) +
    ggplot2::geom_smooth(data = df2, se = T, method = "loess") +
    ggplot2::ylim(0, 1) +
    ggplot2::theme_classic() +
    ggplot2::ylab(paste("Scaled changes in module eigenvalue")) +
    xlab("Inferred Pseudotime") +
    theme(
      axis.text = element_text(size = 12),
      axis.title = element_text(size = 12),
      strip.text = element_text(size = 15, margin = margin())
    ) +facet_wrap(~modules)

  plot
  return(plot)
}

.range01 <- function(x) {
  (x - min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
}
