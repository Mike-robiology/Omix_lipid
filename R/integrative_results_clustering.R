#' Downstream analysis for integrated multi-omics data - Clustering models
#'
#' @param multiassay Multiassay experiment object generated by Omix
#' @param integration_model Possible clustering integration methods are `iCluster`
#' @param dependent Dependent variable for groups.
#' @param correlation_threshold Absolute correlation threshold to draw edges
#' in the network
#' @param log2FoldChange logFC cutoff
#' @param disease_id OpenTargets disease id. Default to "MONDO_0004975"
#' (Alzheimer's Disease) Different disease ontologies can be found on
#' https://www.ebi.ac.uk/ols/ontologies
#' @param sense_check_variable sense check
#' @param covariates clinical covariates
#' @param probability_threshold Posterior probability minimum threshold
#' @param community_detection community detection method
#' @param TF_fp file path GMT file with Transcription Factors and target genes. Check `https://maayanlab.cloud/chea3/`
#'
#' @return List object of integrated results
#'
#' @family Multi-omic integration downstream analysis
#'
#' @importFrom purrr possibly
#' @importFrom clusterProfiler enrichGO compareCluster
#' @importFrom enrichplot pairwise_termsim
#' @importFrom org.Hs.eg.db org.Hs.eg.db
#' @importFrom MOFA2 get_weights correlate_factors_with_covariates plot_variance_explained
#' @export

integrative_results_clustering <- function(multiassay,
                                           integration_model = "iCluster",
                                           dependent = "diagnosis",
                                           sense_check_variable = "PHF1",
                                           covariates = c("PHF1", "amyloid", "PHF1"),
                                           probability_threshold = 0.8,
                                           correlation_threshold = 0.4,
                                           log2FoldChange = 1,
                                           community_detection = "leading_eigen",
                                           disease_id = "MONDO_0004975",
                                           TF_fp) {
  cli::cli_h2("Generating integrative muti-omics results ")

  integrated_object <- multiassay@metadata$integration[[integration_model]]
  clusters <- integrated_object$clusters

  multimodal <- multiassay@metadata$multimodal_object$omics
  metadata <- multiassay@metadata$multimodal_object$metadata


  ## Demographics
  metadata$cluster <- as.factor(paste0("C", clusters))

  perCombs <- split(
    t(combn(levels(metadata$cluster), 2)),
    seq(nrow(t(combn(levels(metadata$cluster), 2))))
  )


  expressions <- list()
  for (i in 1:length(perCombs)) {
    expressions[i] <- paste0(perCombs[[i]][2], "-", perCombs[[i]][1])
  }
  names(perCombs) <- unlist(expressions)
  ## Differential expression
  cli::cli_text("Cluster differential expression analysis...")

  DE_res <- list()
  list_results=list()

  DE_res <- lapply(perCombs, function(x) {
    res1 <- clustering_DE_analysis(
      normalized_data = multimodal$mRNA,
      colData = metadata,
      dependent = "cluster",
      levels = x,
      log2FoldChange = log2FoldChange,
      omic = "mRNA"
    )

    res2 <- clustering_DE_analysis(
      normalized_data = multimodal$proteins,
      colData = metadata,
      dependent = "cluster",
      levels = x,
      log2FoldChange = log2FoldChange,
      omic = "protein"
    )

    DE_res <- list(
      rna = res1,
      proteins = res2
    )

    return(DE_res)
  })

list_results <- lapply(names(DE_res), function(x) {

  Up <- list()
  Down <- list()

Up <- list(
  rna = DE_res[[x]]$rna$sig_feature[[1]]$up,
  protein = DE_res[[x]]$protein$sig_feature[[1]]$up
)
Down <- list(
  rna = DE_res[[x]]$rna$sig_feature[[1]]$down,
  protein = DE_res[[x]]$protein$sig_feature[[1]]$down
)

list_results<- list(Up=Up,
                    Down=Down)

return(list_results)
})

names(list_results)=names(DE_res)
  ## Multi-omics network

  cli::cli_text("Retrieving weights...")
  weights <- posterior_probability(integrated_object,
    multimodal,
    metadata,
    threshold = probability_threshold,
    sense_check_variable = sense_check_variable
  )


  multiomic_networks <- list()
  cell_type <- list()
  enrichment <- list()
  TF <- list()
  modules <- list()
  boxplots <- list()
  OpenTargets_results <- list()
  communities_up <- list()
  communities_down <- list()

  for (i in names(list_results)) {
    cli::cli_text(i)
    cli::cli_text("Generating multi-omics network...")
    multiomic_networks[[i]]$up <- multiomics_network(
      multiassay = multiassay,
      list = list_results[[i]]$Up,
      correlation_threshold = correlation_threshold
    )

    multiomic_networks[[i]]$down <- multiomics_network(
      multiassay = multiassay,
      list = list_results[[i]]$Down,
      correlation_threshold = correlation_threshold
    )


    ## Network communities detection
    cli::cli_text("Detecting network communities...")
    communities_pos_neg <- list()
    communities_pos_neg[[i]]$up <- communities_network(
      igraph = multiomic_networks[[i]]$up$graph,
      community_detection = community_detection
    )
    communities_pos_neg[[i]]$down <- communities_network(
      igraph = multiomic_networks[[i]]$down$graph,
      community_detection = community_detection
    )


    ## Cell type enrichment
    cli::cli_text("Cell type enrichment of communities...")


    cell_type[[i]]$up <- cell_type_enrichment(
      multiassay = multiassay,
      communities = lapply(communities_pos_neg[[i]]$up$communities, function(x) {
        sub("\\_.*", "", x)
      })
    )
    cell_type[[i]]$down <- cell_type_enrichment(
      multiassay = multiassay,
      communities = lapply(communities_pos_neg[[i]]$down$communities, function(x) {
        sub("\\_.*", "", x)
      })
    )


    ## Functional enrichment
    cli::cli_text("Functional enrichment of communities...")

    communities_up[[i]] <- lapply(communities_pos_neg[[i]]$up$communities, function(x) {
      sub("\\_.*", "", x)
    })
    communities_down[[i]] <- lapply(communities_pos_neg[[i]]$down$communities, function(x) {
      sub("\\_.*", "", x)
    })


    enrichment[[i]]$up <- lapply(communities_up[[i]], pathway_analysis_enrichr)
    enrichment[[i]]$down <- lapply(communities_down[[i]], pathway_analysis_enrichr)

    ## Transcription Factor enrichment
    cli::cli_text("Transcription factor - target gene enrichment in communities...")


    TF[[i]]$up <- Transcription_Factor_enrichment(
      communities = communities_pos_neg[[i]]$up$communities,
      weights = weights,
      TF_gmt = TF_fp,
      threshold = weights_threshold,
      direction = "positive"
    )

    TF[[i]]$down <- Transcription_Factor_enrichment(
      communities = communities_pos_neg[[i]]$down$communities,
      weights = weights,
      TF_gmt = TF_fp,
      threshold = weights_threshold,
      direction = "positive"
    )


    ## Multi-omics modules (eigenvalue)
    cli::cli_text("Computing module eigen expression for communities...")
    metadata$cluster=as.numeric(metadata$cluster)
    modules[[i]]$up <- multiomics_modules(
      multiassay = multiassay,
      metadata = metadata,
      covariates = c(covariates, "cluster"),
      communities = communities_pos_neg[[i]]$up$communities,
    )

    modules[[i]]$down <- multiomics_modules(
      multiassay = multiassay,
      metadata = metadata,
      covariates = c(covariates, "cluster"),
      communities = communities_pos_neg[[i]]$down$communities,
    )


    for (j in colnames(modules$positive$modules_eigen_value)) {
      boxplots[[i]]$up[[j]] <- ggpubr::ggboxplot(modules[[i]]$up$metadata_modules,
        x = dependent,
        y = paste(j),
        add = "jitter",
        color = dependent
      ) +
        xlab(paste(dependent)) +
        ylab(paste("Eigen value in", j)) +
        theme_classic() +
        ggsignif::geom_signif() +
        scale_color_manual(values = c("#2E9FDF", "#E7B800"))
    }


    for (j in colnames(modules$negative$modules_eigen_value)) {
      boxplots[[i]]$down[[j]] <- ggpubr::ggboxplot(modules[[i]]$down$metadata_modules,
        x = dependent,
        y = paste(j),
        add = "jitter",
        color = dependent
      ) +
        xlab(paste(dependent)) +
        ylab(paste("Eigen value in", j)) +
        theme_classic() +
        ggsignif::geom_signif() +
        scale_color_manual(values = c("#2E9FDF", "#E7B800"))
    }

    ### Open targets
    cli::cli_text("Testing association of targets with disease of interest via the Open Targets API...")


    OpenTargets_results[[i]]$up$rna$df <- OpenTarget_dataframe(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Up$rna
    )

    OpenTargets_results[[i]]$up$rna$plot <- plot_OpenTarget(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Up$rna
    )

    OpenTargets_results[[i]]$up$protein$df <- OpenTarget_dataframe(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Up$protein
    )

    OpenTargets_results[[i]]$up$protein$plot <- plot_OpenTarget(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Up$protein
    )

    OpenTargets_results[[i]]$down$rna$df <- OpenTarget_dataframe(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Down$rna
    )

    OpenTargets_results[[i]]$down$rna$plot <- plot_OpenTarget(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Down$rna
    )

    OpenTargets_results[[i]]$down$protein$df <- OpenTarget_dataframe(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Down$protein
    )

    OpenTargets_results[[i]]$down$protein$plot <- plot_OpenTarget(
      disease_id = disease_id,
      size = 1000,
      genes = list_results[[i]]$Down$protein
    )
  }

  ## Correlation heatmap
  correlation_heatmap <-  correlation_heatmap_clusters(integrated_object,
                                                      metadata=metadata,
                                                covariates = covariates
  )



  ## Track param
  parameters <- list(
    integration_model = integration_model,
    dependent = dependent,
    log2FoldChange = log2FoldChange,
    sense_check_variable = sense_check_variable,
    covariates = covariates,
    probability_threshold = probability_threshold,
    correlation_threshold = correlation_threshold,
    community_detection = community_detection,
    disease_id = disease_id
  )

  #### RESULTS OBJECT
  integrative_results <- list(
    differential_expression=DE_res,
    de_features=list_results,
    correlation_heatmap = correlation_heatmap,
    weights = weights,
    multiomic_networks = multiomic_networks,
    communities = communities_pos_neg,
    cell_type = cell_type,
    functional_enrichment = enrichment,
    TF = TF,
    modules = modules,
    boxplots = boxplots,
    OpenTargets = OpenTargets_results,
    analysis_parameters = parameters
  )


  MultiAssayExperiment::metadata(multiassay)$integrative_results[[integration_model]] <- integrative_results
  return(multiassay)
}


