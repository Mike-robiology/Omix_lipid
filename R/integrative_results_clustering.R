#' Downstream analysis for integrated multi-omics clustering
#'
#' @param multiassay Multiassay experiment object generated by Omix
#' `generate_multiassay`function
#' @param integration Possible multiomics clustering include `iCluster`
#' @param annotations_cat categorical covariates
#' @param correlation_threshold Absolute correlation threshold to draw edges
#' in the network
#' @param enrichment_method Available methods include `enrichGO` and `enrichr`.
#' Default to `enrichr`.
#' @param annotations_continuous continuous covariates
#' @param geneset Default to NULL
#'
#' @return List object of integrated results
#'
#' @family  Multi-omic integration downstream analysis
#'
#' @importFrom stringr str_split
#' @importFrom cli cli_alert_success
#' @importFrom readr parse_number
#' @importFrom clusterProfiler compareCluster
#'
#' @export
#'
integrative_results_clustering <- function(multiassay,
                                           integration = "iCluster",
                                           enrichment_method,
                                           annotations_continuous,
                                           annotations_cat,
                                           res.path,
                                           correlation_threshold = 0.5,
                                           geneset = NULL) {
  multimodal <- multiassay@metadata$multimodal_object$omics
  metadata <- multiassay@metadata$multimodal_object$metadata
  multimodal <- lapply(multimodal, data.frame)

  cluster <- multiassay@metadata$integration[[paste(integration)]]

  columns <- c(annotations_continuous, annotations_cat)
  annCol <- metadata[, c(paste(columns)), drop = FALSE]

  cli::cli_alert_success("MULTI-OMICS CLUSTERING HEATMAP")
  annCol <- mutate_if(annCol, is.character, as.factor)

  surv.info <- annCol
  surv.info$Subtype <- cluster$clust.res$clust

  cli::cli_alert_success("RELATING CLUSTERS TO CLINICAL INFORMATION")
  clinical.clust <- MOVICS::compClinvar(
    moic.res = cluster,
    var2comp = surv.info, # data.frame needs to summarize
                          # (must has row names of samples)
    strata = "Subtype",
    factorVars = c("var1", "var2", "var3", "var4"),
    doWord = TRUE,
    includeNA = FALSE, # generate .docx file in local path
    tab.name = "Clinical features per clusters"
  )

  surv.info$Cluster <- paste0("CS", surv.info$Subtype)

  cli::cli_alert_success("RUNNING DIFFERENTIAL EXPRESSION ANALYSIS")
  res1 <- clustering_DE_analysis(
    normalized_data = multimodal$rna_processed,
    colData = surv.info,
    dependent = "Cluster",
    levels = c("CS2", "CS1"),
    log2FoldChange = 0.5
  )


  res2 <- clustering_DE_analysis(
    normalized_data = multimodal$protein_processed,
    colData = surv.info,
    dependent = "Cluster",
    levels = c("CS2", "CS1"),
    log2FoldChange = 0.2
  )

  DE_res <- list(
    rna = res1,
    proteins = res2
  )

  Up <- list()
  Down <- list()

  for (i in names(DE_res$rna$sig_feature)) {
    Up[[i]] <- list(
      rna = DE_res$rna$sig_feature[[i]]$up,
      protein = DE_res$protein$sig_feature[[i]]$up
    )
    Down[[i]] <- list(
      rna = DE_res$rna$sig_feature[[i]]$down,
      protein = DE_res$protein$sig_feature[[i]]$down
    )
  }

  cli::cli_alert_success("BIPARTITE NETWORKS GENERATION OF DIFFERENTIALLY
                         EXPRESSED FEATURES IN EACH CLUSTER")

  Down_network <- list()
  Up_network <- list()
  Up_communities <- list()
  Down_communities <- list()
  Up_cell_type <- list()
  Down_cell_type <- list()

  for (i in names(Up)) {
    cli::cli_alert_success(paste("UP REGULATED FEATURES (", i, ")
                                 DOWNSTREAM ANALYSIS"))

    cluster <- stringr::str_split(names(Up), "-", n = 2, simplify = FALSE)
    cluster <- readr::parse_number(cluster[[1]][1])

    Up_network[[i]] <- multiomics_network_cluster(
      multiassay = multiassay,
      integration = "iCluster",
      cluster = cluster,
      list = Up[[i]],
      correlation_threshold = correlation_threshold
    )
    cli::cli_alert_success("DETECTION OF NETWORK COMMUNITIES")
    Up_communities[[i]] <- communities_network(Up_network[[i]])

    cli::cli_alert_success("CELL TYPE ENRICHMENT OF COMMUNITIES")
    Up_cell_type[[i]] <- cell_type_enrichment(
      multiassay = multiassay,
      communities = Up_communities[[i]]
    )
  }

  for (i in names(Down)) {
    cli::cli_alert_success(paste("DOWN REGULATED FEATURES (", i, ")
                                 DOWNSTREAM ANALYSIS"))

    cluster <- stringr::str_split(names(Down), "-", n = 2, simplify = FALSE)
    cluster <- readr::parse_number(cluster[[1]][1])
    Down_network[[i]] <- multiomics_network_cluster(
      multiassay = multiassay,
      integration = "iCluster",
      cluster = cluster,
      list = Down[[i]],
      correlation_threshold = correlation_threshold
    )



    cli::cli_alert_success("DETECTION OF NETWORK COMMUNITIES")
    Down_communities[[i]] <- communities_network(Down_network[[i]])

    cli::cli_alert_success("CELL TYPE ENRICHMENT OF COMMUNITIES")

    Down_cell_type[[i]] <- cell_type_enrichment(
      multiassay = multiassay,
      communities = Down_communities[[i]]
    )
  }


  cli::cli_alert_success("FUNCTIONAL ENRICHMENT OF UP AND DOWN REGULATED FEATURES")
  for (i in names(Up)) {
    Up[[i]] <- lapply(Up[[i]], function(x) {
      sub("*\\.[0-9]", "", x)
    })
  }

  for (i in names(Down)) {
    Down[[i]] <- lapply(Down[[i]], function(x) {
      sub("*\\.[0-9]", "", x)
    })
  }

  background <- get_background(multiassay = multiassay, of = "full")


  if (enrichment_method == "enrichr") {
    enrichr_Down <- list()
    enrichr_Up <- list()
    for (i in names(Up)) {
      enrichr_Down[[i]] <- lapply(Down[[i]], pathway_analysis_enrichr)
      enrichr_Up[[i]] <- lapply(Up[[i]], pathway_analysis_enrichr)
    }
  }


  if (!is.null(custom_geneset)) {
    custom_Down <- list()
    custom_Up <- list()

    for (i in names(Up)) {
      custom_Down[[i]] <- lapply(Down[[i]], function(x) {
        enrichment_custom(x, background, geneset, adj = "fdr", verbose = FALSE)
      })

      custom_Up[[i]] <- lapply(Down[[i]], function(x) {
        enrichment_custom(x, background, geneset, adj = "fdr", verbose = FALSE)
      })
    }
  }

  # Comparison of communities
  cli::cli_alert_success("FUNCTIONALLY COMPARING UP AND DOWN REGULATED FEATURES")

  comp_list <- list()
  comp <- list()

  for (i in names(Up)) {
    for (j in names(Up[[i]])) {
      comp_list[[i]][[j]] <- list(
        up = Up[[i]][[j]],
        down = Down[[i]][[j]]
      )

      cli::cli_alert_success(paste("Comparing up vs down regulated", j, "in", i))

      comp[[i]][[j]] <- clusterProfiler::compareCluster(
        geneCluster = comp_list[[i]][[j]],
        fun = "enrichGO",
        OrgDb = "org.Hs.eg.db",
        keyType = "SYMBOL",
        universe = background,
        ont = "BP",
        minGSSize = 2,
        pAdjustMethod = "BH",
        pvalueCutoff = 0.05,
        qvalueCutoff = 0.05
      )
    }
  }

  #### RESULTS OBJECT
  integrative_results <- list(
    clinical = clinical.clust,
    DE = DE_res,
    Down = list(
      multiomics_signature = Down,
      network = Down_network,
      network_communities = Down_communities,
      cell_type_communities = Down_cell_type,
      enrichment = enrichr_Down
    ),
    Up = list(
      multiomics_signature = Up,
      network = Up_network,
      network_communities = Up_communities,
      cell_type_communities = Up_cell_type,
      enrichment = enrichr_Up
    ),
    comparison = comp
  )


  return(integrative_results)
}
