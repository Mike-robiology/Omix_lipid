################################################################################
#' Patient specific vertical integration
#'
#' @param multiassay Multiassay experiment object generated by Omix
#' @param slots Default are processed slots
#' @param intersect_genes Logical whether to intersect common features for
#'integration
#' @param dependent
#' @param map_by_column
#' @param integration Possible integration methods are `MOFA`,
#' `DIABLO`,`sMBPLS`
#' @param ncomp
#' @param range
#'
#' @return
#' @export
#'
#' @examples
vertical_integration <- function(multiassay,
                                 slots = c(
                                   "rna_processed",
                                   "protein_processed"
                                 ),
                                 intersect_genes=FALSE,
                                 dependent = "Group",
                                 levels = c("Control", "Case"),
                                 map_by_column = "individualID",
                                 integration = c("MOFA", "DIABLO", "sMBPLS"),
                                 ncomp = 2,
                                 range = seq(5, 100, by = 10)) {

  multimodal_object <- .get_multimodal_object(
    multiassay,
    slots,
    intersect_genes
  )

  multimodal <- multimodal_object[[1]]
  metadata <- multimodal_object[[2]]
  rownames(metadata) <- metadata[[paste(map_by_column)]]

  Y <- metadata[[paste(dependent)]]
  Y <- factor(Y, levels = levels)

  multimodal_omics <- lapply(multimodal@ExperimentList@listData, as.matrix)
  multimodal_omics <- lapply(multimodal_omics, "colnames<-", rownames(metadata))


  if (integration == "DIABLO") {
    cli::cli_alert_success("VERTICAL INTEGRATION WITH DIABLO")
    int <- integrate_with_DIABLO(
      multimodal_omics,
      ncomp,
      range
    )
  }

  if (integration == "sMBPLS") {
    cli::cli_alert_success("VERTICAL INTEGRATION WITH sMBPLS")
    int <- integrate_with_sMBPLS(
      multimodal_omics,
      Y,
      ncomp,
      range
    )
  }

  if (integration == "MOFA") {
    cli::cli_alert_success("VERTICAL INTEGRATION WITH MOFA")
    int <- integrate_with_MOFA(multimodal_omics)
  }

  multiassay@metadata$multimodal_object <- int[[1]]
  multiassay@metadata$integration[[paste(integration)]] <- int[[2]]

  return(multiassay)
}
